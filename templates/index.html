<!DOCTYPE html>
<html lang="ru" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Учет анализов - Malvin Vet Analytics</title>
    
    <!-- Фавикон -->
    <link rel="shortcut icon" href="https://static.tildacdn.com/tild3931-3964-4333-a139-616331303063/favicon.ico" type="image/x-icon"> 
    <link rel="apple-touch-icon" href="https://static.tildacdn.com/tild6461-3331-4337-b635-306361643663/304.png"> 
    <link rel="apple-touch-icon" sizes="76x76" href="https://static.tildacdn.com/tild6461-3331-4337-b635-306361643663/304.png"> 
    <link rel="apple-touch-icon" sizes="152x152" href="https://static.tildacdn.com/tild6461-3331-4337-b635-306361643663/304.png"> 
    <link rel="apple-touch-startup-image" href="https://static.tildacdn.com/tild6461-3331-4337-b635-306361643663/304.png"> 
    <meta name="msapplication-TileColor" content="#000000"> 
    <meta name="msapplication-TileImage" content="https://static.tildacdn.com/tild3061-3563-4638-a463-663764313862/540.png">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Кастомные стили -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <style>
        :root {
            --malvin-blue: #1a365d;
            --malvin-light-blue: #2c5282;
            --malvin-accent: #ff770f;
            --malvin-success: #ff770f;
            --malvin-warning: #ed8936;
            --malvin-danger: #dc3545;
            --blood-color: #dc3545; /* Красный для крови */
            --urine-color: #ffc107; /* Жёлтый для мочи */
            --feces-color: #8B4513; /* Коричневый для кала */
            --vet-union-color: #0d6efd; /* Синий для Вет Юнион */
            --dermatology-color: #99ff99; /* HEX#99ff99 для дерматологии */
            --manual-color: #8b00ff; /* HEX#8b00ff для добавленных вручную */
            --archive-color: #6c757d; /* Серый для архива */
        }
        
        .navbar-logo {
            height: 40px;
            margin-right: 10px;
        }
        
        .stats-card {
            border-left: 4px solid var(--malvin-accent);
        }
        
        .analysis-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Стили для цветов анализов */
        .badge-blood {
            background-color: var(--blood-color) !important;
            border-color: var(--blood-color) !important;
        }
        
        .badge-urine {
            background-color: var(--urine-color) !important;
            border-color: var(--urine-color) !important;
            color: #212529 !important;
        }
        
        .badge-feces {
            background-color: var(--feces-color) !important;
            border-color: var(--feces-color) !important;
        }
        
        .badge-vet-union {
            background-color: var(--vet-union-color) !important;
            border-color: var(--vet-union-color) !important;
        }
        
        .badge-dermatology {
            background-color: var(--dermatology-color) !important;
            border-color: var(--dermatology-color) !important;
            color: #212529 !important;
        }
        
        .badge-manual {
            background-color: var(--manual-color) !important;
            border-color: var(--manual-color) !important;
        }
        
        .badge-cytology {
            background-color: #17a2b8 !important;
            border-color: #17a2b8 !important;
        }
        
        .badge-histology {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
        }
        
        .badge-archive {
            background-color: var(--archive-color) !important;
            border-color: var(--archive-color) !important;
        }
        
        .action-btn {
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .doctor-progress {
            height: 8px;
            border-radius: 4px;
        }
        
        .tab-content {
            min-height: 400px;
        }
        
        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: #6c757d;
        }
        
        .filter-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .table tbody tr:hover {
            background-color: rgba(255, 119, 15, 0.05);
        }
        
        .date-input {
            font-family: monospace;
        }
        
        /* Стили для кнопок действий в таблице */
        .action-buttons-group {
            display: flex;
            gap: 4px; /* Отступ между кнопками */
        }
        
        .action-buttons-group .btn {
            border-radius: 4px !important; /* Скругленные края для всех кнопок */
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .action-buttons-group .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .action-buttons-group .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        .action-buttons-group .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .action-buttons-group .btn-primary:hover {
            background-color: #0069d9;
            border-color: #0062cc;
        }
        
        .action-buttons-group .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .action-buttons-group .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        
        .action-buttons-group .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        .action-buttons-group .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        
        /* Стили для выравнивания фильтров */
        .filter-row {
            align-items: center;
            margin-bottom: 0;
        }
        
        .filter-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .filter-buttons {
            height: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 1.5rem;
        }
        
        .filter-buttons .btn {
            height: 38px; /* Такая же высота как у инпутов */
        }
        
        .reset-btn {
            color: #dc3545 !important;
            border-color: #dc3545 !important;
            background-color: transparent !important;
        }
        
        .reset-btn:hover {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        /* Компактные стили для фильтров */
        .compact-filters .col-md-3 {
            padding-bottom: 0.5rem;
        }
        
        /* Логотип в навбаре */
        .navbar-brand-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .navbar-brand-logo img {
            height: 42px;
            width: auto;
            object-fit: contain;
        }
        
        .navbar-brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .navbar-brand-text .brand-name {
            font-weight: 700;
            font-size: 1.2rem;
            line-height: 1.2;
        }
        
        .navbar-brand-text .brand-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
            line-height: 1.2;
        }
        
        /* Улучшенные вкладки с оранжевой линией */
        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            border-bottom: none;
            position: relative;
            margin-bottom: -1px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: white;
            border-color: #dee2e6 #dee2e6 white;
            color: var(--malvin-blue);
            font-weight: 600;
        }
        
        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--malvin-accent);
            border-radius: 3px 3px 0 0;
        }
        
        .nav-tabs .nav-link:not(.active):hover {
            background-color: rgba(255, 119, 15, 0.05);
            border-color: rgba(255, 119, 15, 0.2);
        }
        
        /* Карточка быстрых действий */
        .quick-actions-card .btn {
            border-radius: 6px;
            padding: 8px 16px;
        }
        
        /* Общие стили для модальных окон подтверждения */
        .confirm-modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .confirm-modal-content {
            border-radius: 12px;
            overflow: hidden;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .confirm-modal-header {
            border-bottom: none;
            padding: 1.5rem;
        }
        
        .confirm-modal-body {
            padding: 2rem;
            text-align: center;
        }
        
        .confirm-modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 1.5rem;
            justify-content: center;
            gap: 1rem;
        }
        
        .analysis-details {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }
        
        .detail-value {
            color: #212529;
            flex-grow: 1;
        }
        
        /* Специфичные стили для модального окна звонка */
        .call-modal-header {
            background: linear-gradient(135deg, var(--malvin-blue) 0%, var(--malvin-light-blue) 100%);
            color: white;
        }
        
        .call-modal-icon {
            color: var(--malvin-accent);
        }
        
        /* Специфичные стили для модального окна удаления */
        .delete-modal-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .delete-modal-icon {
            color: #dc3545;
        }
        
        .warning-text {
            color: #dc3545;
            font-weight: 600;
        }
        
        .warning-note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
        }
        
        .warning-note i {
            color: #856404;
        }
        
        /* Липкая панель статистики */
        .sticky-sidebar {
            position: sticky;
            top: 20px;
            z-index: 100;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .sticky-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sticky-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .sticky-sidebar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .sticky-sidebar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Футер с разработчиком */
        .footer-developer {
            color: white !important;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            opacity: 0.9;
        }
        
        .footer-developer:hover {
            color: white !important;
            opacity: 1;
            text-decoration: none;
        }
        
        /* Стили для информационного алерта в архиве */
        .alert-archive-info {
            border-left: 4px solid #6c757d;
        }
        
        /* Медиа-запросы для адаптивности */
        @media (max-width: 991.98px) {
            .sticky-sidebar {
                position: static;
                max-height: none;
                overflow-y: visible;
            }
            
            .filter-buttons {
                margin-top: 0;
            }
        }
        
        @media (max-width: 767.98px) {
            .compact-filters .col-md-3 {
                padding-bottom: 1rem;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
        
        /* Стили для ID пациента */
        .patient-id-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            background-color: #6f42c1;
            color: white;
        }
        
        /* Стили для дней назад */
        .days-ago {
            font-size: 0.7rem;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, var(--malvin-blue) 0%, var(--malvin-light-blue) 100%);">
        <div class="container-fluid">
            <!-- Логотип с изображением -->
            <a class="navbar-brand navbar-brand-logo" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Malvin Vet Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="navbar-brand-text">
                    <span class="brand-name text-light">Malvin Vet</span>
                    <span class="brand-subtitle text-light">Analytics System</span>
                </div>
            </a>
            
            <!-- Мобильное меню -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Основное меню -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('index') }}">
                            <i class="bi bi-house-door me-1"></i>Главная
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('add_analysis') }}">
                            <i class="bi bi-plus-circle me-1"></i>Добавить анализ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upload_csv') }}">
                            <i class="bi bi-upload me-1"></i>Загрузить CSV
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('view_logs') }}">
                            <i class="bi bi-journal-text me-1"></i>Логи
                        </a>
                    </li>
                </ul>
                
                <!-- Правая часть навигации -->
                <div class="d-flex align-items-center">
                    <span class="text-light me-3 d-none d-md-block" style="cursor: pointer;" 
                          data-bs-toggle="modal" data-bs-target="#userMenuModal">
                        <i class="bi bi-person-circle me-1"></i>
                        {{ session.username if session.username else 'Администратор' }}
                    </span>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-box-arrow-right me-1"></i>Выйти
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Основная колонка (левая) -->
            <div class="col-lg-8">
                <!-- Уведомления -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
                                <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <!-- Фильтры -->
                <div class="card filter-card mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-funnel me-2"></i>Фильтры
                        </h5>
                        
                        <form method="GET" action="{{ url_for('index') }}" class="row g-3 filter-row compact-filters">
                            <!-- Выбор врача -->
                            <div class="col-md-3">
                                <label class="form-label filter-label">Врач</label>
                                <select name="doctor_id" class="form-select">
                                    <option value="">Все врачи</option>
                                    {% for doctor in doctors %}
                                    <option value="{{ doctor.id }}" {% if selected_doctor == doctor.id %}selected{% endif %}>
                                        {{ doctor.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Поиск по тексту -->
                            <div class="col-md-3">
                                <label class="form-label filter-label">Поиск</label>
                                <input type="text" name="search" class="form-control" 
                                       placeholder="Фамилия, кличка, анализ, ID пациента..." 
                                       value="{{ search_query }}">
                            </div>
                            
                            <!-- Фильтр по дате -->
                            <div class="col-md-3">
                                <label class="form-label filter-label">Дата создания</label>
                                <input type="text" name="date" class="form-control date-input" 
                                       placeholder="ДД.ММ.ГГГГ" 
                                       value="{{ date_filter }}">
                            </div>
                            
                            <!-- Кнопки фильтрации -->
                            <div class="col-md-3">
                                <div class="filter-buttons">
                                    <button type="submit" class="btn btn-primary flex-grow-1">
                                        <i class="bi bi-search me-1"></i>Применить
                                    </button>
                                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary reset-btn" title="Сбросить фильтры">
                                        <i class="bi bi-x-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Быстрые действия -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card quick-actions-card">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="bi bi-lightning me-2"></i>Быстрые действия
                                </h5>
                                <div class="d-flex flex-wrap gap-2">
                                    <a href="{{ url_for('add_analysis') }}" class="btn btn-primary action-btn">
                                        <i class="bi bi-plus-circle me-2"></i>Добавить анализ
                                    </a>
                                    <a href="{{ url_for('upload_csv') }}" class="btn btn-success action-btn">
                                        <i class="bi bi-upload me-2"></i>Загрузить CSV
                                    </a>
                                    <a href="{{ url_for('view_logs') }}" class="btn btn-info action-btn text-light">
                                        <i class="bi bi-journal-text me-2"></i>Просмотр логов
                                    </a>
                                    <a href="{{ url_for('export_data') }}" class="btn btn-warning action-btn">
                                        <i class="bi bi-download me-2"></i>Экспорт данных
                                    </a>
                                    <button type="button" class="btn btn-outline-secondary action-btn" data-bs-toggle="modal" data-bs-target="#addDoctorModal">
                                        <i class="bi bi-person-plus me-2"></i>Добавить врача
                                    </button>
                                    <form method="POST" action="{{ url_for('archive_old') }}" class="d-inline">
                                        <button type="submit" class="btn btn-outline-dark action-btn" onclick="return confirm('Переместить все свежие обработанные анализы в архив?')">
                                            <i class="bi bi-archive me-2"></i>Архивировать старые
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Вкладки -->
                <ul class="nav nav-tabs mb-3" id="analysisTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="actual-tab" data-bs-toggle="tab" 
                                data-bs-target="#actual-content" type="button" role="tab">
                            <i class="bi bi-clock-history me-2"></i>
                            Актуальные анализы
                            <span class="badge bg-warning ms-2">{{ actual_analyses|length }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="processed-tab" data-bs-toggle="tab" 
                                data-bs-target="#processed-content" type="button" role="tab">
                            <i class="bi bi-check-circle me-2"></i>
                            Проработанные
                            <span class="badge bg-success ms-2">{{ processed_analyses|length }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="archived-tab" data-bs-toggle="tab" 
                                data-bs-target="#archived-content" type="button" role="tab">
                            <i class="bi bi-archive me-2"></i>
                            Архивированные
                            <span class="badge bg-secondary ms-2">{{ archived_analyses|length }}</span>
                        </button>
                    </li>
                </ul>
                
                <!-- Содержимое вкладок -->
                <div class="tab-content" id="analysisTabContent">
                    <!-- Актуальные анализы -->
                    <div class="tab-pane fade show active" id="actual-content" role="tabpanel">
                        {% if actual_analyses %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="100">Статус</th>
                                        <th>Врач</th>
                                        <th>Фамилия владельца</th>
                                        <th>Кличка</th>
                                        <th>Тип анализа</th>
                                        <th>ID</th>
                                        <th width="150">Дата создания</th>
                                        <th width="200">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for analysis in actual_analyses %}
                                    <tr class="align-middle">
                                        <td>
                                            <span class="badge bg-warning analysis-badge">
                                                <i class="bi bi-clock me-1"></i>Ожидает
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}</strong>
                                        </td>
                                        <td>{{ analysis.client_surname }}</td>
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                {{ analysis.pet_name }}
                                            </span>
                                        </td>
                                        <td>
                                            {% set analysis_colors = {
                                                'Кровь': 'blood',
                                                'Моча': 'urine', 
                                                'Кал': 'feces',
                                                'Цитология': 'cytology',
                                                'Гистология': 'histology',
                                                'Вет Юнион': 'vet-union',
                                                'Дерматология': 'dermatology'
                                            } %}
                                            {% if analysis.analysis_type in analysis_colors %}
                                            <span class="badge badge-{{ analysis_colors[analysis.analysis_type] }} analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% else %}
                                            <span class="badge badge-manual analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if analysis.patient_id %}
                                            <span class="badge patient-id-badge">
                                                {{ analysis.patient_id }}
                                            </span>
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="action-buttons-group">
                                                <!-- Кнопка для открытия модального окна подтверждения звонка -->
                                                <button type="button" class="btn btn-success" 
                                                        title="Отметить звонок"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#confirmCallModal"
                                                        data-analysis-id="{{ analysis.id }}"
                                                        data-client-surname="{{ analysis.client_surname }}"
                                                        data-pet-name="{{ analysis.pet_name }}"
                                                        data-analysis-type="{{ analysis.analysis_type }}"
                                                        data-doctor-name="{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}"
                                                        data-patient-id="{{ analysis.patient_id or '' }}"
                                                        data-created-at="{{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}">
                                                    <i class="bi bi-telephone"></i>
                                                </button>
                                                <a href="{{ url_for('edit_analysis', analysis_id=analysis.id) }}" 
                                                   class="btn btn-primary" title="Редактировать">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <!-- Кнопка для открытия модального окна подтверждения удаления -->
                                                <button type="button" class="btn btn-danger" 
                                                        title="Удалить"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#confirmDeleteModal"
                                                        data-analysis-id="{{ analysis.id }}"
                                                        data-client-surname="{{ analysis.client_surname }}"
                                                        data-pet-name="{{ analysis.pet_name }}"
                                                        data-analysis-type="{{ analysis.analysis_type }}"
                                                        data-doctor-name="{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}"
                                                        data-patient-id="{{ analysis.patient_id or '' }}"
                                                        data-created-at="{{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}"
                                                        data-analysis-status="{{ analysis.status }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-clipboard-check display-4 mb-3"></i>
                            <h4>Нет актуальных анализов</h4>
                            <p class="text-muted">
                                {% if selected_doctor or search_query or date_filter %}
                                Для выбранных фильтров нет актуальных анализов
                                {% else %}
                                Все анализы обработаны или добавьте новые
                                {% endif %}
                            </p>
                            <a href="{{ url_for('add_analysis') }}" class="btn btn-primary mt-2">
                                <i class="bi bi-plus-circle me-2"></i>Добавить анализ
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Проработанные анализы -->
                    <div class="tab-pane fade" id="processed-content" role="tabpanel">
                        {% if processed_analyses %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="100">Статус</th>
                                        <th>Врач</th>
                                        <th>Фамилия владельца</th>
                                        <th>Кличка</th>
                                        <th>Тип анализа</th>
                                        <th>ID</th>
                                        <th width="150">Дата обработки</th>
                                        <th width="200">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for analysis in processed_analyses %}
                                    <tr class="align-middle">
                                        <td>
                                            <span class="badge bg-success analysis-badge">
                                                <i class="bi bi-check-circle me-1"></i>Обработан
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}</strong>
                                        </td>
                                        <td>{{ analysis.client_surname }}</td>
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                {{ analysis.pet_name }}
                                            </span>
                                        </td>
                                        <td>
                                            {% set analysis_colors = {
                                                'Кровь': 'blood',
                                                'Моча': 'urine', 
                                                'Кал': 'feces',
                                                'Цитология': 'cytology',
                                                'Гистология': 'histology',
                                                'Вет Юнион': 'vet-union',
                                                'Дерматология': 'dermatology'
                                            } %}
                                            {% if analysis.analysis_type in analysis_colors %}
                                            <span class="badge badge-{{ analysis_colors[analysis.analysis_type] }} analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% else %}
                                            <span class="badge badge-manual analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if analysis.patient_id %}
                                            <span class="badge patient-id-badge">
                                                {{ analysis.patient_id }}
                                            </span>
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% if analysis.call_date %}
                                                {{ analysis.call_date.strftime('%d.%m.%Y %H:%M') }}
                                                {% if now and analysis.call_date %}
                                                <br><small class="days-ago">(~{{ ((now - analysis.call_date).days) }} д. назад)</small>
                                                {% endif %}
                                                {% else %}
                                                Не указана
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="action-buttons-group">
                                                <a href="{{ url_for('edit_analysis', analysis_id=analysis.id) }}" 
                                                   class="btn btn-primary" title="Редактировать">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <!-- Кнопка для открытия модального окна подтверждения удаления -->
                                                <button type="button" class="btn btn-danger" 
                                                        title="Удалить"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#confirmDeleteModal"
                                                        data-analysis-id="{{ analysis.id }}"
                                                        data-client-surname="{{ analysis.client_surname }}"
                                                        data-pet-name="{{ analysis.pet_name }}"
                                                        data-analysis-type="{{ analysis.analysis_type }}"
                                                        data-doctor-name="{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}"
                                                        data-patient-id="{{ analysis.patient_id or '' }}"
                                                        data-created-at="{{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}"
                                                        data-analysis-status="{{ analysis.status }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                <!-- Кнопка перемещения в архив -->
                                                <form method="POST" action="{{ url_for('archive_analysis', analysis_id=analysis.id) }}" class="d-inline">
                                                    <input type="hidden" name="redirect_doctor_id" value="{{ selected_doctor or '' }}">
                                                    <input type="hidden" name="redirect_search" value="{{ search_query or '' }}">
                                                    <input type="hidden" name="redirect_date" value="{{ date_filter or '' }}">
                                                    <button type="submit" class="btn btn-secondary" title="Переместить в архив" onclick="return confirm('Переместить этот анализ в архив?')">
                                                        <i class="bi bi-archive"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-clipboard-data display-4 mb-3"></i>
                            <h4>Нет проработанных анализов</h4>
                            <p class="text-muted">
                                {% if selected_doctor or search_query or date_filter %}
                                Для выбранных фильтров нет проработанных анализов
                                {% else %}
                                Начните отмечать анализы как обработанные
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Архивированные анализы -->
                    <div class="tab-pane fade" id="archived-content" role="tabpanel">
                        {% if archived_analyses %}
                        <div class="alert alert-info alert-archive-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Анализы, обработанные более 7 дней назад. Не участвуют в общей статистике.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="100">Статус</th>
                                        <th>Врач</th>
                                        <th>Фамилия владельца</th>
                                        <th>Кличка</th>
                                        <th>Тип анализа</th>
                                        <th>ID</th>
                                        <th width="150">Дата создания</th>
                                        <th width="150">Дата обработки</th>
                                        <th width="120">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for analysis in archived_analyses %}
                                    <tr class="align-middle">
                                        <td>
                                            <span class="badge bg-secondary analysis-badge">
                                                <i class="bi bi-archive me-1"></i>Архив
                                            </span>
                                        </td>
                                        <td>
                                            <strong>{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}</strong>
                                        </td>
                                        <td>{{ analysis.client_surname }}</td>
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                {{ analysis.pet_name }}
                                            </span>
                                        </td>
                                        <td>
                                            {% set analysis_colors = {
                                                'Кровь': 'blood',
                                                'Моча': 'urine', 
                                                'Кал': 'feces',
                                                'Цитология': 'cytology',
                                                'Гистология': 'histology',
                                                'Вет Юнион': 'vet-union',
                                                'Дерматология': 'dermatology'
                                            } %}
                                            {% if analysis.analysis_type in analysis_colors %}
                                            <span class="badge badge-{{ analysis_colors[analysis.analysis_type] }} analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% else %}
                                            <span class="badge badge-manual analysis-badge">
                                                {{ analysis.analysis_type }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if analysis.patient_id %}
                                            <span class="badge patient-id-badge">
                                                {{ analysis.patient_id }}
                                            </span>
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}
                                            </small>
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {% if analysis.call_date %}
                                                {{ analysis.call_date.strftime('%d.%m.%Y %H:%M') }}
                                                {% if now and analysis.call_date %}
                                                <br><small class="days-ago">(~{{ ((now - analysis.call_date).days) }} д. назад)</small>
                                                {% endif %}
                                                {% else %}
                                                Не указана
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            <div class="action-buttons-group">
                                                <a href="{{ url_for('edit_analysis', analysis_id=analysis.id) }}" 
                                                   class="btn btn-primary" title="Редактировать">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                                <!-- Кнопка для открытия модального окна подтверждения удаления -->
                                                <button type="button" class="btn btn-danger" 
                                                        title="Удалить"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#confirmDeleteModal"
                                                        data-analysis-id="{{ analysis.id }}"
                                                        data-client-surname="{{ analysis.client_surname }}"
                                                        data-pet-name="{{ analysis.pet_name }}"
                                                        data-analysis-type="{{ analysis.analysis_type }}"
                                                        data-doctor-name="{{ analysis.doctor.name if analysis.doctor else 'Не указан' }}"
                                                        data-patient-id="{{ analysis.patient_id or '' }}"
                                                        data-created-at="{{ analysis.created_at.strftime('%d.%m.%Y %H:%M') }}"
                                                        data-analysis-status="archived">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-archive display-4 mb-3"></i>
                            <h4>Нет архивных анализов</h4>
                            <p class="text-muted">
                                {% if selected_doctor or search_query or date_filter %}
                                Для выбранных фильтров нет архивных анализов
                                {% else %}
                                В архиве пока нет анализов. Анализы автоматически попадают в архив через 7 дней после обработки.
                                {% endif %}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Панель статистики (правая колонка) -->
            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    <!-- Общая статистика -->
                    <div class="card stats-card mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <i class="bi bi-bar-chart me-2"></i>Общая статистика
                            </h5>
                            
                            <div class="row text-center mb-4">
                                <div class="col-3">
                                    <div class="display-6 fw-bold text-primary">{{ total_analyses }}</div>
                                    <small class="text-muted">Всего активных</small>
                                </div>
                                <div class="col-3">
                                    <div class="display-6 fw-bold text-warning">{{ actual_count }}</div>
                                    <small class="text-muted">Актуальные</small>
                                </div>
                                <div class="col-3">
                                    <div class="display-6 fw-bold text-success">{{ processed_count }}</div>
                                    <small class="text-muted">Обработано</small>
                                </div>
                                <div class="col-3">
                                    <div class="display-6 fw-bold text-secondary">{{ archived_count }}</div>
                                    <small class="text-muted">В архиве</small>
                                </div>
                            </div>
                            
                            <!-- Прогресс бар -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Прогресс обработки (без архива)</small>
                                    <small>
                                        {% if total_analyses > 0 %}
                                        {{ ((processed_count / total_analyses) * 100)|round|int }}%
                                        {% else %}
                                        0%
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-success" 
                                         style="width: {% if total_analyses > 0 %}{{ (processed_count / total_analyses * 100) }}{% else %}0{% endif %}%">
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Архивные анализы ({{ archived_count }}) не учитываются в статистике
                                </small>
                            </div>
                            
                            <!-- Информация о фильтрах -->
                            {% if selected_doctor or search_query or date_filter %}
                            <div class="mt-4 pt-3 border-top">
                                <h6 class="mb-2">
                                    <i class="bi bi-funnel me-1"></i>Примененные фильтры:
                                </h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% if selected_doctor %}
                                    {% set doctor_name = doctors|selectattr('id', 'equalto', selected_doctor)|map(attribute='name')|first %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-person me-1"></i>{{ doctor_name }}
                                    </span>
                                    {% endif %}
                                    
                                    {% if search_query %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-search me-1"></i>"{{ search_query }}"
                                    </span>
                                    {% endif %}
                                    
                                    {% if date_filter %}
                                    <span class="badge bg-info">
                                        <i class="bi bi-calendar me-1"></i>{{ date_filter }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Статистика по врачам -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <i class="bi bi-people me-2"></i>Статистика по врачам
                            </h5>
                            
                            <div class="list-group list-group-flush">
                                {% for stat in doctor_stats if stat.total > 0 %}
                                <div class="list-group-item border-0 px-0 py-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong class="d-block">{{ stat.name }}</strong>
                                            <small class="text-muted">
                                                {{ stat.processed }}/{{ stat.total }} обработано
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge {% if stat.progress == 100 %}bg-success{% else %}bg-warning{% endif %}">
                                                {{ stat.progress }}%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="progress doctor-progress">
                                        <div class="progress-bar {% if stat.progress == 100 %}bg-success{% else %}bg-warning{% endif %}" 
                                             style="width: {{ stat.progress }}%">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if doctor_stats|selectattr('total', 'gt', 0)|list|length == 0 %}
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-people display-6 mb-3"></i>
                                    <p>Нет данных по врачам</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Информация о системе -->
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-info-circle me-2"></i>Информация
                            </h6>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-2"></i>
                                        Сегодня: {{ now.strftime('%d.%m.%Y') if now else '' }}
                                    </small>
                                </li>
                                <li class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-database me-2"></i>
                                        Всего врачей: {{ doctors|length }}
                                    </small>
                                </li>
                                <li class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-clock-history me-2"></i>
                                        Актуальные анализы: {{ actual_count }}
                                    </small>
                                </li>
                                <li class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Обработанные анализы: {{ processed_count }}
                                    </small>
                                </li>
                                <li>
                                    <small class="text-muted">
                                        <i class="bi bi-archive me-2"></i>
                                        Архивированные анализы: {{ archived_count }}
                                    </small>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения отметки звонка -->
    <div class="modal fade" id="confirmCallModal" tabindex="-1" aria-labelledby="confirmCallModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content confirm-modal-content">
                <div class="modal-header confirm-modal-header call-modal-header">
                    <h5 class="modal-title" id="confirmCallModalLabel">
                        <i class="bi bi-telephone me-2"></i>Подтверждение звонка
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="confirm-modal-icon call-modal-icon">
                        <i class="bi bi-telephone-outbound"></i>
                    </div>
                    <h4 class="mb-3">Отметить анализ как обработанный?</h4>
                    <p class="text-muted mb-4">
                        После подтверждения анализ будет перемещен в раздел "Проработанные" и появится в логах
                    </p>
                    
                    <div class="analysis-details">
                        <h6 class="mb-3">Информация об анализе:</h6>
                        <div class="detail-row">
                            <span class="detail-label">Владелец:</span>
                            <span class="detail-value" id="modalCallClientSurname"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Кличка:</span>
                            <span class="detail-value" id="modalCallPetName"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Тип анализа:</span>
                            <span class="detail-value" id="modalCallAnalysisType"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Врач:</span>
                            <span class="detail-value" id="modalCallDoctorName"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ID пациента:</span>
                            <span class="detail-value" id="modalCallPatientId"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Дата создания:</span>
                            <span class="detail-value" id="modalCallCreatedAt"></span>
                        </div>
                    </div>
                    
                    <form id="confirmCallForm" method="POST" action="">
                        <!-- Скрытые поля для сохранения фильтров -->
                        <input type="hidden" name="redirect_doctor_id" value="{{ selected_doctor or '' }}">
                        <input type="hidden" name="redirect_search" value="{{ search_query or '' }}">
                        <input type="hidden" name="redirect_date" value="{{ date_filter or '' }}">
                        <input type="hidden" name="analysis_id" id="modalCallAnalysisId">
                    </form>
                </div>
                <div class="modal-footer confirm-modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Отмена
                    </button>
                    <button type="button" class="btn btn-success" id="confirmCallButton">
                        <i class="bi bi-check-circle me-1"></i>Да, отметить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подтверждения удаления анализа -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content confirm-modal-content">
                <div class="modal-header confirm-modal-header delete-modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Подтверждение удаления
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="confirm-modal-icon delete-modal-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <h4 class="mb-3 warning-text">Вы уверены, что хотите удалить анализ?</h4>
                    <p class="text-muted mb-4">
                        Это действие нельзя отменить. Все данные об анализе будут безвозвратно удалены.
                    </p>
                    
                    <div class="warning-note">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Внимание!</strong> Удаление приведет к безвозвратной потере данных.
                    </div>
                    
                    <div class="analysis-details">
                        <h6 class="mb-3">Информация об анализе:</h6>
                        <div class="detail-row">
                            <span class="detail-label">Владелец:</span>
                            <span class="detail-value" id="modalDeleteClientSurname"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Кличка:</span>
                            <span class="detail-value" id="modalDeletePetName"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Тип анализа:</span>
                            <span class="detail-value" id="modalDeleteAnalysisType"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Врач:</span>
                            <span class="detail-value" id="modalDeleteDoctorName"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">ID пациента:</span>
                            <span class="detail-value" id="modalDeletePatientId"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Дата создания:</span>
                            <span class="detail-value" id="modalDeleteCreatedAt"></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Статус:</span>
                            <span class="detail-value" id="modalDeleteAnalysisStatus"></span>
                        </div>
                    </div>
                    
                    <form id="confirmDeleteForm" method="POST" action="">
                        <!-- Скрытые поля для сохранения фильтров -->
                        <input type="hidden" name="redirect_doctor_id" value="{{ selected_doctor or '' }}">
                        <input type="hidden" name="redirect_search" value="{{ search_query or '' }}">
                        <input type="hidden" name="redirect_date" value="{{ date_filter or '' }}">
                        <input type="hidden" name="analysis_id" id="modalDeleteAnalysisId">
                    </form>
                </div>
                <div class="modal-footer confirm-modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Отмена
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                        <i class="bi bi-trash me-1"></i>Да, удалить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления врача -->
    <div class="modal fade" id="addDoctorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus me-2"></i>Добавить врача
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('add_doctor') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="doctorName" class="form-label">ФИО врача</label>
                            <input type="text" class="form-control" id="doctorName" name="name" 
                                   placeholder="Например: Иванов И.И." required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Добавить врача</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно пользователя со сбросом базы данных -->
    <div class="modal fade" id="userMenuModal" tabindex="-1" aria-labelledby="userMenuModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--malvin-blue) 0%, var(--malvin-light-blue) 100%);">
                    <h5 class="modal-title text-white" id="userMenuModalLabel">
                        <i class="bi bi-person-circle me-2"></i>Управление аккаунтом
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Информация о пользователе -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-person-badge me-2"></i>Информация об аккаунте
                                    </h6>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Имя пользователя</small>
                                        <strong>{{ session.username if session.username else 'Администратор' }}</strong>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Роль</small>
                                        <span class="badge bg-primary">Администратор</span>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Статус</small>
                                        <span class="badge bg-success">Активен</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-speedometer2 me-2"></i>Быстрые действия
                                    </h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                            <i class="bi bi-key me-2"></i>Сменить пароль
                                        </button>
                                        <a href="{{ url_for('view_logs') }}" class="btn btn-outline-info">
                                            <i class="bi bi-journal-text me-2"></i>Просмотр логов
                                        </a>
                                        <a href="{{ url_for('export_data') }}" class="btn btn-outline-success">
                                            <i class="bi bi-download me-2"></i>Экспорт данных
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Опасные операции -->
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm border-danger mb-4">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Опасные операции
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted small mb-3">
                                        Эти действия могут привести к необратимой потере данных. 
                                        Выполняйте их только при крайней необходимости.
                                    </p>
                                    
                                    <!-- Сброс анализов в актуальные -->
                                    <div class="mb-3">
                                        <h6 class="mb-2">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Сбросить все анализы
                                        </h6>
                                        <p class="small text-muted mb-2">
                                            Вернет все анализы в статус "Актуальные". Не удаляет записи из базы.
                                        </p>
                                        <form method="GET" action="{{ url_for('reset_all') }}" class="d-inline">
                                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Вы уверены, что хотите сбросить все анализы в статус \"Актуальные\"?')">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Сбросить анализы
                                            </button>
                                        </form>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <!-- Полный сброс базы данных -->
                                    <div>
                                        <h6 class="mb-2 text-danger">
                                            <i class="bi bi-trash3 me-2"></i>Полный сброс базы данных
                                        </h6>
                                        <p class="small text-danger mb-2">
                                            ⚠️ Удалит ВСЕ анализы и врачей, заменив врачей на список по умолчанию.
                                        </p>
                                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#resetDatabaseModal">
                                            <i class="bi bi-trash3 me-1"></i>Сбросить базу данных
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Статистика системы -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">
                                        <i class="bi bi-database me-2"></i>Статистика системы
                                    </h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Анализов</small>
                                            <strong class="fs-5">{{ total_analyses + archived_count }}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">Врачей</small>
                                            <strong class="fs-5">{{ doctors|length }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                        <i class="bi bi-box-arrow-right me-1"></i>Выйти из системы
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно подтверждения сброса базы данных -->
    <div class="modal fade" id="resetDatabaseModal" tabindex="-1" aria-labelledby="resetDatabaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetDatabaseModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Подтверждение сброса базы данных
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <form method="POST" action="{{ url_for('reset_database') }}" id="resetDatabaseForm">
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <h6 class="alert-heading">
                                <i class="bi bi-exclamation-octagon-fill me-2"></i>Внимание! Это опасная операция!
                            </h6>
                            <p class="mb-0 small">
                                Это действие приведет к удалению всех анализов и врачей из базы данных. 
                                Восстановить данные будет невозможно!
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="mb-3">Будут удалены:</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-clipboard-data text-danger me-2"></i>
                                        Все анализы
                                    </span>
                                    <span class="badge bg-danger rounded-pill">{{ total_analyses + archived_count }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="bi bi-person text-danger me-2"></i>
                                        Все врачи
                                    </span>
                                    <span class="badge bg-danger rounded-pill">{{ doctors|length }}</span>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-key me-2"></i>Введите пароль для подтверждения
                            </h6>
                            <input type="password" class="form-control mb-2" name="password" 
                                   placeholder="Пароль" required>
                            <input type="password" class="form-control" name="confirm_password" 
                                   placeholder="Повторите пароль" required>
                        </div>
                        
                        <div class="mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-chat-square-text me-2"></i>Текстовое подтверждение
                            </h6>
                            <input type="text" class="form-control" name="confirmation" 
                                   placeholder='Введите "сбросить базу данных"' required>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                            <label class="form-check-label text-danger" for="confirmDelete">
                                <strong>Я понимаю, что это действие необратимо и удалит все данные</strong>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-danger" id="resetDatabaseButton">
                            <i class="bi bi-trash3 me-1"></i>Сбросить базу данных
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно смены пароля (заглушка) -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-key me-2"></i>Смена пароля
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Функция смены пароля временно недоступна. Обратитесь к системному администратору.
                    </div>
                    <p class="text-muted small">
                        Текущие учетные данные:<br>
                        <strong>Логин:</strong> Malvin_42<br>
                        <strong>Пароль:</strong> 585188
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="mt-5 py-4" style="background: linear-gradient(135deg, var(--malvin-blue) 0%, var(--malvin-light-blue) 100%);">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Malvin Vet Logo" height="30" class="me-2" onerror="this.style.display='none'">
                        <div class="text-light">
                            <strong>Malvin Vet Analytics System</strong>
                            <small class="d-block opacity-75 mt-1">© 2025 Все права защищены</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <a href="https://github.com/FeirlyMoore" target="_blank" class="footer-developer">
                        <i class="bi bi-github me-1"></i>Developed by Feirly Moore
                    </a>
                </div>
                <div class="col-md-4 text-md-end">
                    <small class="text-light opacity-75">
                        Версия 1.2 | 
                        <i class="bi bi-cpu ms-2 me-1"></i>Всего анализов: {{ total_analyses + archived_count }}
                        {% if selected_doctor or search_query or date_filter %}
                        <br><i class="bi bi-funnel ms-2 me-1"></i>Фильтры применены
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Кастомный JS -->
    <script>
        // Активация вкладок при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Сохраняем активную вкладку в localStorage
            const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
            tabEls.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    localStorage.setItem('activeTab', event.target.id);
                });
            });
            
            // Восстанавливаем активную вкладку
            const activeTab = localStorage.getItem('activeTab');
            if (activeTab) {
                const tabTrigger = new bootstrap.Tab(document.getElementById(activeTab));
                tabTrigger.show();
            }
            
            // Автоматическое скрытие алертов через 5 секунд
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
            
            // Маска для ввода даты
            const dateInput = document.querySelector('input[name="date"]');
            if (dateInput) {
                dateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 2) {
                        value = value.slice(0, 2) + '.' + value.slice(2);
                    }
                    if (value.length > 5) {
                        value = value.slice(0, 5) + '.' + value.slice(5, 9);
                    }
                    e.target.value = value;
                });
                
                // Подсказка с сегодняшней датой при фокусе
                dateInput.addEventListener('focus', function() {
                    if (!this.value) {
                        const today = new Date();
                        const day = String(today.getDate()).padStart(2, '0');
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const year = today.getFullYear();
                        const formattedDate = `${day}.${month}.${year}`;
                        this.placeholder = 'Например: ' + formattedDate;
                    }
                });
                
                dateInput.addEventListener('blur', function() {
                    this.placeholder = 'ДД.ММ.ГГГГ';
                });
            }
            
            // Если логотип не загрузился, показываем иконку
            const logoImg = document.querySelector('.navbar-brand img');
            if (logoImg) {
                logoImg.addEventListener('error', function() {
                    const fallback = document.createElement('div');
                    fallback.className = 'd-flex align-items-center';
                    fallback.innerHTML = '<i class="bi bi-heart-pulse fs-3 text-light me-2"></i>';
                    this.parentNode.insertBefore(fallback, this);
                    this.style.display = 'none';
                });
            }
            
            // Обработка модального окна подтверждения звонка
            const confirmCallModal = document.getElementById('confirmCallModal');
            if (confirmCallModal) {
                confirmCallModal.addEventListener('show.bs.modal', function(event) {
                    // Кнопка, которая вызвала модальное окно
                    const button = event.relatedTarget;
                    
                    // Извлекаем информацию из data-* атрибутов
                    const analysisId = button.getAttribute('data-analysis-id');
                    const clientSurname = button.getAttribute('data-client-surname');
                    const petName = button.getAttribute('data-pet-name');
                    const analysisType = button.getAttribute('data-analysis-type');
                    const doctorName = button.getAttribute('data-doctor-name');
                    const patientId = button.getAttribute('data-patient-id');
                    const createdAt = button.getAttribute('data-created-at');
                    
                    // Обновляем содержимое модального окна
                    document.getElementById('modalCallAnalysisId').value = analysisId;
                    document.getElementById('modalCallClientSurname').textContent = clientSurname;
                    document.getElementById('modalCallPetName').textContent = petName;
                    document.getElementById('modalCallAnalysisType').textContent = analysisType;
                    document.getElementById('modalCallDoctorName').textContent = doctorName;
                    document.getElementById('modalCallPatientId').textContent = patientId || '—';
                    document.getElementById('modalCallCreatedAt').textContent = createdAt;
                    
                    // Обновляем action формы
                    const form = document.getElementById('confirmCallForm');
                    form.action = `/analysis/${analysisId}/mark_called`;
                });
                
                // Обработка нажатия кнопки подтверждения
                const confirmCallButton = document.getElementById('confirmCallButton');
                if (confirmCallButton) {
                    confirmCallButton.addEventListener('click', function() {
                        document.getElementById('confirmCallForm').submit();
                    });
                }
            }
            
            // Обработка модального окна подтверждения удаления
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            if (confirmDeleteModal) {
                confirmDeleteModal.addEventListener('show.bs.modal', function(event) {
                    // Кнопка, которая вызвала модальное окно
                    const button = event.relatedTarget;
                    
                    // Извлекаем информацию из data-* атрибутов
                    const analysisId = button.getAttribute('data-analysis-id');
                    const clientSurname = button.getAttribute('data-client-surname');
                    const petName = button.getAttribute('data-pet-name');
                    const analysisType = button.getAttribute('data-analysis-type');
                    const doctorName = button.getAttribute('data-doctor-name');
                    const patientId = button.getAttribute('data-patient-id');
                    const createdAt = button.getAttribute('data-created-at');
                    const analysisStatus = button.getAttribute('data-analysis-status');
                    
                    // Переводим статус на русский
                    let statusText = 'Неизвестно';
                    if (analysisStatus === 'actual') {
                        statusText = 'Актуальный';
                    } else if (analysisStatus === 'processed') {
                        statusText = 'Обработанный';
                    } else if (analysisStatus === 'archived') {
                        statusText = 'Архивный';
                    }
                    
                    // Обновляем содержимое модального окна
                    document.getElementById('modalDeleteAnalysisId').value = analysisId;
                    document.getElementById('modalDeleteClientSurname').textContent = clientSurname;
                    document.getElementById('modalDeletePetName').textContent = petName;
                    document.getElementById('modalDeleteAnalysisType').textContent = analysisType;
                    document.getElementById('modalDeleteDoctorName').textContent = doctorName;
                    document.getElementById('modalDeletePatientId').textContent = patientId || '—';
                    document.getElementById('modalDeleteCreatedAt').textContent = createdAt;
                    document.getElementById('modalDeleteAnalysisStatus').textContent = statusText;
                    
                    // Обновляем action формы
                    const form = document.getElementById('confirmDeleteForm');
                    form.action = `/analysis/${analysisId}/delete`;
                });
                
                // Обработка нажатия кнопки подтверждения удаления
                const confirmDeleteButton = document.getElementById('confirmDeleteButton');
                if (confirmDeleteButton) {
                    confirmDeleteButton.addEventListener('click', function() {
                        document.getElementById('confirmDeleteForm').submit();
                    });
                }
            }
        });

        // Проверка формы сброса базы данных
        const resetDatabaseForm = document.getElementById('resetDatabaseForm');
        if (resetDatabaseForm) {
            const resetDatabaseButton = document.getElementById('resetDatabaseButton');
            const confirmCheckbox = document.getElementById('confirmDelete');
            
            // Отключаем кнопку по умолчанию
            resetDatabaseButton.disabled = true;
            
            // Включаем кнопку только при установленном чекбоксе
            confirmCheckbox.addEventListener('change', function() {
                resetDatabaseButton.disabled = !this.checked;
            });
            
            // Валидация формы перед отправкой
            resetDatabaseForm.addEventListener('submit', function(e) {
                const password = this.querySelector('input[name="password"]').value;
                const confirmPassword = this.querySelector('input[name="confirm_password"]').value;
                const confirmation = this.querySelector('input[name="confirmation"]').value;
                
                // Проверка пароля
                if (password !== 'FeirlyMoore_42') {
                    alert('Неверный пароль!');
                    e.preventDefault();
                    return false;
                }
                
                // Проверка совпадения паролей
                if (password !== confirmPassword) {
                    alert('Пароли не совпадают!');
                    e.preventDefault();
                    return false;
                }
                
                // Проверка текстового подтверждения
                if (confirmation.toLowerCase() !== 'сбросить базу данных') {
                    alert('Неверное текстовое подтверждение! Введите: "сбросить базу данных"');
                    e.preventDefault();
                    return false;
                }
                
                // Финальное подтверждение
                if (!confirm('❗ ВНИМАНИЕ! Это действие удалит ВСЕ данные без возможности восстановления. Вы уверены?')) {
                    e.preventDefault();
                    return false;
                }
                
                // Показать индикатор загрузки
                resetDatabaseButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Сброс...';
                resetDatabaseButton.disabled = true;
            });
        }
    </script>
</body>
</html>